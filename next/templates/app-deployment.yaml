apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.releaseName }}-{{ .Values.appName }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "next.labels" . | nindent 4 }}
spec:
  revisionHistoryLimit: 1
  replicas: 1
  selector:
    matchLabels:
      {{- include "next.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "next.selectorLabels" . | nindent 8 }}
    spec:
      containers:
        # -------------------------
        # コンテナ1: アプリ本体 (Runner)
        # -------------------------
        - name: {{ .Values.appName }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: 3000
          
          # ... (Probe設定はそのまま) ...
          livenessProbe:
            httpGet:
              path: {{ .Values.app.probes.liveness.path }}
              port: 3000
            initialDelaySeconds: {{ .Values.app.probes.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.app.probes.liveness.periodSeconds }}
            timeoutSeconds: {{ .Values.app.probes.liveness.timeoutSeconds }}
            failureThreshold: {{ .Values.app.probes.liveness.failureThreshold }}
          readinessProbe:
            httpGet:
              path: {{ .Values.app.probes.readiness.path }}
              port: 3000
            initialDelaySeconds: {{ .Values.app.probes.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.app.probes.readiness.periodSeconds }}
            timeoutSeconds: {{ .Values.app.probes.readiness.timeoutSeconds }}
            failureThreshold: {{ .Values.app.probes.readiness.failureThreshold }}
          
          resources:
            {{- toYaml .Values.app.resources | nindent 12 }}

          # ★ 変更点1: ConfigMapを一括読み込み
          # Git管理している 'app-config' の値をすべて環境変数として取り込みます
          envFrom:
            - configMapRef:
                name: app-config

          # ★ 変更点2: Secretを個別に読み込み
          # 手動登録した 'app-secrets' から機密情報を取得します
          env:
            # --- データベース接続情報 (PostgreSQL) ---
            # DBホスト名などはHelmの値を使う場合
            - name: PG_USER
              value: {{ .Values.postgresql.user | quote }}
            - name: PG_DB_NAME
              value: {{ .Values.postgresql.database | quote }}
            # パスワードは app-secrets に含めた DATABASE_URL を使うか、
            # 別途管理しているならここだけ残す（構成によります）
            - name: PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.releaseName }}-postgresql
                  key: password
            
            # --- Secretから読み込む環境変数 ---
            # ※キー名(key)は kubectl create secret で指定した名前(大文字)と一致させる！
            
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DATABASE_URL
            
            - name: SECRET_COOKIE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: SECRET_COOKIE_PASSWORD
            
            - name: EMAIL_SERVER_USER
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: EMAIL_SERVER_USER

            - name: EMAIL_SERVER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: EMAIL_SERVER_PASSWORD

            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: OPENAI_API_KEY
            - name: NEXT_PUBLIC_APP_URL
              value: {{ .Values.appEnv.NEXT_PUBLIC_BASE_URL | quote }}

            # 2. NEXT_PUBLIC_GOOGLE_CLIENT_ID の追加
            # ログで「Too small」と出ていた部分です。
            # アプリは "NEXT_PUBLIC_..." という名前で探していますが、
            # 設定されていたのは "GOOGLE_CLIENT_ID" (サーバー用) だけでした。
            # クライアント側でも使うために、同じSecretを別名で読み込みます。
            - name: NEXT_PUBLIC_GOOGLE_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: GOOGLE_CLIENT_ID  # Secretのキーは元のままでOK
            
            - name: GOOGLE_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: GOOGLE_CLIENT_ID

            - name: GOOGLE_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: GOOGLE_CLIENT_SECRET

        # -------------------------
        # コンテナ2: Prismaマイグレーション用 (Migrator)
        # -------------------------
        - name: prisma-tools
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}{{ .Values.migration.image.tagSuffix }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["/bin/sh", "-c", "tail -f /dev/null"]
          resources:
            requests:
              cpu: "10m"     # 最小限のCPU要求 (0.01コア)
              memory: "32Mi"
            limits:
              cpu: "100m"
              memory: "512Mi"
          env:
            # Migratorにも同じDB接続情報が必要です
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DATABASE_URL