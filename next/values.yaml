# ------------------------------------
# CI/CD (GitHub Actions) が自動更新する場所
# ------------------------------------
image:
  repository: rnagashiro/my-nextjs-app
  pullPolicy: IfNotPresent
  # ★ CIが '9deb18d' のようなコミットハッシュに書き換える
  tag: "0b3c59a"
# ------------------------------------
# アプリケーション設定
# ------------------------------------
appName: my-nextjs-app
releaseName: tss-pre
namespace: tss-pre
# ------------------------------------
# アプリ本体 (Deployment) の設定
# ------------------------------------
app:
  replicaCount: 1
  probes:
    liveness:
      path: "/"
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: "/"
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  autoscaling:
    enabled: true # HPAを有効にする場合はtrueに変更
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80
  pdb:
    enabled: true # PDBを有効にする場合はtrueに変更
    maxUnavailable: 1
# ------------------------------------
# Ingress 設定
# ------------------------------------
ingress:
  enabled: true # Ingressを作成するかどうか
  className: "nginx"
  host: "infopia.nqg1t0.com"
  tlsSecretName: my-nextjs-app-tls
  clusterIssuer: letsencrypt-prod
# ------------------------------------
# アプリ本体 (Deployment) の固定環境変数
# ------------------------------------
appEnv:
  COOKIE_NAME: "session-infopia"
  EMAIL_SERVER_USER: "ainfopiaf6@gmail.com"
  EMAIL_FROM: "ainfopiaf6@gmail.com"
  NEXT_PUBLIC_BASE_URL: "https://infopia.nqg1t0.com"
# ------------------------------------
# DB設定 (PostgreSQL)
# ------------------------------------
postgresql:
  user: "user"
  database: "mydatabase"
  storageClass: "local-path"
  storageSize: 1Gi
# ------------------------------------
# DBマイグレーションJob用設定
# ------------------------------------
migration:
  enabled: true
  # ★ 'image:' という階層でネストするのが正しい
  image:
    tagSuffix: "-migrator"
  # ★ 'command:' は 'migration:' の直下でOK
  command: ["npm", "run", "db:migrate"]
# ------------------------------------
# DBシーディングJob用設定
# ------------------------------------
seeding:
  enabled: true
  command: ["npm", "run", "db:seed"]
# ------------------------------------
# サンドボックス環境 (Code Execution)
# ------------------------------------
sandbox:
  enabled: true
  replicaCount: 2
  image:
    tagSuffix: "-sandbox"
  service:
    port: 4000
  # ▼ resources ブロック
  resources:
    limits:
      cpu: "500m"
      memory: "512Mi"
    requests:
      cpu: "200m"
      memory: "256Mi"
      # ★ ここにあった autoscaling を削除し、下に移動しました
  # ▼ autoscaling ブロック (resourcesと同じ階層にする)
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80
  gvisor:
    enabled: true
# ------------------------------------
# Cloudflared HPA 設定
# ------------------------------------
cloudflared:
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 75
