# ------------------------------------
# CI/CD (GitHub Actions) が自動更新する場所
# ------------------------------------
image:
  # ★変更: Docker Hub から GHCR (GitHub Container Registry) へ変更
  # ※ "rnagashiro" の部分は GitHubのユーザー名/組織名 に合わせてください
  repository: ghcr.io/kdthesixsense/my-nextjs-app
  # ★推奨: Always にしておくと、万が一同じタグで中身が変わっても確実に新しいものを引けます
  pullPolicy: Always
  # ★ CIが自動で書き換えるので、ここはダミーや初期値でOK
  tag: "6cd9f8b"
  digest: "sha256:294ac8ba4679ba343bb9247c675f35532f4dcff6ae2856e097f1f8d1387368c2"
imagePullSecrets:
  - name: ghcr-secret
# ------------------------------------
# アプリケーション設定
# ------------------------------------
appName: my-nextjs-app
releaseName: tss-pre
namespace: tss-pre
# ------------------------------------
# アプリ本体 (Deployment) の設定
# ------------------------------------
app:
  replicaCount: 1
  probes:
    liveness:
      path: "/"
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: "/"
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  autoscaling:
    enabled: true # HPAを有効にする場合はtrueに変更
    minReplicas: 1
    maxReplicas: 4
    targetCPUUtilizationPercentage: 80
  pdb:
    enabled: true # PDBを有効にする場合はtrueに変更
    maxUnavailable: 1
# ------------------------------------
# Ingress 設定
# ------------------------------------
ingress:
  enabled: true # Ingressを作成するかどうか
  className: "nginx"
  host: "infopia.nqg1t0.com"
  tlsSecretName: my-nextjs-app-tls
  clusterIssuer: letsencrypt-prod
# ------------------------------------
# アプリ本体 (Deployment) の固定環境変数
# ------------------------------------
appEnv:
  COOKIE_NAME: "session-infopia"
  EMAIL_SERVER_USER: "ainfopiaf6@gmail.com"
  EMAIL_FROM: "ainfopiaf6@gmail.com"
  NEXT_PUBLIC_BASE_URL: "https://infopia.nqg1t0.com"
  NEXTAUTH_URL: "https://infopia.nqg1t0.com" # ★NextAuthを使うならこれも必要になることが多いです
# ------------------------------------
# DB設定 (PostgreSQL)
# ------------------------------------
postgresql:
  user: "user"
  database: "mydatabase"
  storageClass: "local-path"
  storageSize: 1Gi
# ------------------------------------
# DBマイグレーションJob用設定
# ------------------------------------
migration:
  enabled: true
  # ★ 'image:' という階層でネストするのが正しい
  image:
    tagSuffix: "-migrator"
    digest: "sha256:d2e1f206a6be78165d7a467dbc39c18b003893f76fcab4f9aa1d5ac5580596a0" # ★★★ これを追加してください！ ★★★
  # ★ 'command:' は 'migration:' の直下でOK
  command: ["npm", "run", "db:migrate"]
# ------------------------------------
# DBシーディングJob用設定
# ------------------------------------
seeding:
  enabled: true
  command: ["npm", "run", "db:seed"]
# ------------------------------------
# サンドボックス環境 (Code Execution)
# ------------------------------------
sandbox:
  enabled: true
  replicaCount: 3
  image:
    tagSuffix: "-sandbox"
    digest: "sha256:4aaca727019c44df4a16ad81d1a2d5961b9ae5404d8cb1aa5be9776805a0f19a"
  service:
    port: 4000
  # ▼ resources ブロック
  resources:
    limits:
      cpu: "500m"
      memory: "512Mi"
    requests:
      cpu: "200m"
      memory: "256Mi"
      # ★ ここにあった autoscaling を削除し、下に移動しました
  # ▼ autoscaling ブロック (resourcesと同じ階層にする)
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 4
    targetCPUUtilizationPercentage: 80
  gvisor:
    enabled: true
# ------------------------------------
# Cloudflared HPA 設定
# ------------------------------------
cloudflared:
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 75
